spring:
  application:
    name: challenges-service

  datasource:
    url: ${POSTGRES_URL}
    username: ${POSTGRES_USERNAME}
    password: ${POSTGRES_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      auto-commit: false

  jpa:
    hibernate:
      ddl-auto: update
      naming:
        physical-strategy: com.levelupjourney.microservicechallenges.shared.infrastructure.persistence.jpa.configuration.strategy.SnakeCaseWithPluralizedTablePhysicalNamingStrategy
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: false
    show-sql: false
    open-in-view: true

  # --- Configuración de Kafka (Azure Event Hubs) ---
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS}
    properties:
      security.protocol: SASL_SSL
      sasl.mechanism: PLAIN
      sasl.jaas.config: 'org.apache.kafka.common.security.plain.PlainLoginModule required username="$ConnectionString" password="${KAFKA_CONNECTION_STRING}";'

    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        max.block.ms: 2000
        request.timeout.ms: 2000
        delivery.timeout.ms: 3000
        spring:
          json:
            add:
              type:
                headers: false
    
    # Deshabilitar auto-creación para Azure Event Hubs
    # Azure Event Hubs no soporta Kafka Admin API
    admin:
      auto-create: false
      fail-fast: false

server:
  port: ${PORT:8083}

# JWT Configuration
jwt:
  secret: ${JWT_SECRET}

# Kafka Topics Configuration
kafka:
  topics:
    challenge-completed: challenge.completed

# CORRECTED gRPC Configuration - Fixed address format
grpc:
  client:
    code-runner:
      address: discovery:///code-runner-service
      negotiation-type: plaintext
      max-inbound-message-size: 8MB

    code-runner-fallback:
      address: discovery:///code-runner-service
      negotiation-type: plaintext
      max-inbound-message-size: 8MB

# Configuration for Service Discovery
eureka:
  client:
    service-url:
      defaultZone: ${SERVICE_DISCOVERY_URL}
    register-with-eureka: true
    fetch-registry: true
  instance:
    # ⚙️ En Azure o redes internas, NO usar IP pública
    prefer-ip-address: false

    # Usa el nombre del contenedor / app como hostname (Azure resuelve el DNS)
    hostname: ${HOSTNAME:${spring.application.name}}

    # URLs para que Eureka vea el estado y salud del servicio
    status-page-url: http://${eureka.instance.hostname}:${server.port:8083}/swagger-ui/index.html
    health-check-url: http://${eureka.instance.hostname}:${server.port:8083}/actuator/health

    # Identificador único para esta instancia
    instance-id: ${spring.application.name}:${server.port:8083}

    # Intervalos de comunicación con Eureka
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90

# --- Configuración de Actuator ---
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
